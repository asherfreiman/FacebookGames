<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cash Game Calculator</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; max-width: 1000px; margin: 24px auto; padding: 0 16px; }
    input, button { font-size: 16px; padding: 10px; }
    input { width: 100%; }
    .row { display: flex; gap: 12px; align-items: end; margin-top: 12px; flex-wrap: wrap; }
    .muted { color: #666; }
    .error { color: #b00020; white-space: pre-wrap; margin-top: 10px; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 14px; margin-top: 14px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border-bottom: 1px solid #eee; padding: 10px; text-align: left; }
    th { background: #fafafa; }
    .right { text-align: right; }
    .nav a { margin-right: 12px; }
    .pill { display:inline-block; padding: 2px 10px; border:1px solid #ddd; border-radius: 999px; background:#fafafa; margin-left:8px; font-size: 13px; }
    .btn-secondary { background:#f3f3f3; border:1px solid #ddd; border-radius:10px; }
  </style>
</head>
<body>
  <div class="nav">
    <a href="/">TT Calculator</a>
    <a href="/cash.html"><b>Cash Game Calculator</b></a>
  </div>

  <h1>Cash Game Calculator</h1>
  <p class="muted">
    Spots are counted from <b>Round 1</b> (each time a name/emoji appears).
    Wins are how many times that name finishes <b>top of a round</b>.
    <br/>
    Net = (wins × $ per win) − (spots × entry fee).
  </p>

  <div class="card">
    <label>
      Verify link / code
      <input id="url" placeholder="https://giveaways.random.org/verify/eyueov OR eyueov" />
    </label>

    <div class="row">
      <label style="min-width: 220px;">
        $ per win
        <input id="perTop" type="number" inputmode="decimal" step="0.01" value="100" />
      </label>

      <label style="min-width: 220px;">
        Entry fee (per spot)
        <input id="entryFee" type="number" inputmode="decimal" step="0.01" value="150" />
      </label>

      <button id="run">Generate totals</button>
      <button id="clear" type="button" class="btn-secondary">Clear</button>
      <span id="status" class="muted"></span>
    </div>

    <div id="err" class="error"></div>
  </div>

  <div class="card">
    <h2 style="margin-top:0;">Results</h2>
    <div class="muted" id="meta"></div>

    <!-- STREAKS (no extra wording) -->
    <div id="streakCard" class="card" style="margin-top:12px; display:none;">
      <div style="display:flex; gap:12px; flex-wrap:wrap;">
        <div style="flex:1; min-width:260px;">
          <div><b>Longest streak</b><span class="pill" id="bestLenPill"></span></div>
          <div id="bestStreakText" style="margin-top:6px;"></div>
        </div>

        <div style="flex:1; min-width:260px;">
          <div><b>All 4+ streaks</b><span class="pill" id="fourPlusPill"></span></div>
          <div id="fourPlusText" style="margin-top:6px;"></div>
        </div>
      </div>
    </div>

    <table id="tbl" style="display:none;">
      <thead>
        <tr>
          <th>Player</th>
          <th class="right">Spots</th>
          <th class="right">Wins</th>
          <th class="right">Gross</th>
          <th class="right">Entry paid</th>
          <th class="right">Net</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
      <tfoot>
        <tr>
          <th>Totals</th>
          <th></th>
          <th></th>
          <th class="right" id="totalGross"></th>
          <th class="right" id="totalEntry"></th>
          <th class="right" id="totalNet"></th>
        </tr>
      </tfoot>
    </table>
  </div>

  <script>
    const API = "/api/generate";

    const urlEl = document.getElementById("url");
    const perTopEl = document.getElementById("perTop");
    const entryFeeEl = document.getElementById("entryFee");
    const runBtn = document.getElementById("run");
    const clearBtn = document.getElementById("clear");
    const statusEl = document.getElementById("status");
    const errEl = document.getElementById("err");
    const metaEl = document.getElementById("meta");
    const tbl = document.getElementById("tbl");
    const tbody = document.getElementById("tbody");
    const totalGrossEl = document.getElementById("totalGross");
    const totalEntryEl = document.getElementById("totalEntry");
    const totalNetEl = document.getElementById("totalNet");

    // streak UI
    const streakCard = document.getElementById("streakCard");
    const bestLenPill = document.getElementById("bestLenPill");
    const bestStreakText = document.getElementById("bestStreakText");
    const fourPlusPill = document.getElementById("fourPlusPill");
    const fourPlusText = document.getElementById("fourPlusText");

    function money(n) {
      const x = Number(n) || 0;
      return x.toLocaleString(undefined, { style: "currency", currency: "USD" });
    }

    function stripOurNumbering(line) {
      return String(line).replace(/^\s*\d+\.\s*/, "").trim();
    }

    function normKey(s) {
      return String(s || "")
        .replace(/\u00A0/g, " ")
        .replace(/\u202F/g, " ")
        .replace(/\u2007/g, " ")
        .replace(/[ \t]+/g, " ")
        .trim();
    }

    // Build per-round winners in order from topList
    function buildFirstPlaceSequence(topLines) {
      const seq = [];
      const arr = Array.isArray(topLines) ? topLines : [];
      for (const line of arr) {
        const name = normKey(stripOurNumbering(line));
        if (name) seq.push(name);
      }
      return seq;
    }

    function getAllStreaks(firstPlaceSequence, minLen = 4) {
      const streaks = [];
      let i = 0;
      while (i < firstPlaceSequence.length) {
        const spot = firstPlaceSequence[i];
        if (!spot) { i++; continue; }
        let j = i + 1;
        while (j < firstPlaceSequence.length && firstPlaceSequence[j] === spot) j++;
        const len = j - i;
        if (len >= minLen) streaks.push({ spot, len, startIndex: i, endIndex: j - 1 });
        i = j;
      }
      return streaks;
    }

    function getLongestStreak(firstPlaceSequence) {
      let best = { spot: null, len: 0, startIndex: -1, endIndex: -1 };
      let i = 0;
      while (i < firstPlaceSequence.length) {
        const spot = firstPlaceSequence[i];
        if (!spot) { i++; continue; }
        let j = i + 1;
        while (j < firstPlaceSequence.length && firstPlaceSequence[j] === spot) j++;
        const len = j - i;
        if (len > best.len) best = { spot, len, startIndex: i, endIndex: j - 1 };
        i = j;
      }
      return best;
    }

    function renderStreaks(firstPlaceSequence) {
      streakCard.style.display = "none";
      bestLenPill.textContent = "";
      bestStreakText.textContent = "";
      fourPlusPill.textContent = "";
      fourPlusText.textContent = "";

      if (!Array.isArray(firstPlaceSequence) || firstPlaceSequence.length === 0) return;

      const best = getLongestStreak(firstPlaceSequence);
      const streaks4 = getAllStreaks(firstPlaceSequence, 4);

      streakCard.style.display = "block";

      bestLenPill.textContent = best.len ? `${best.len} in a row` : `—`;
      if (!best.spot || best.len === 0) {
        bestStreakText.textContent = "No streak data.";
      } else {
        bestStreakText.innerHTML =
          `<b>${best.spot}</b> went 1st <b>${best.len}</b> straight rounds (rounds #${best.startIndex + 1}–#${best.endIndex + 1}).`;
      }

      fourPlusPill.textContent = streaks4.length ? `${streaks4.length} streak(s)` : `0 streaks`;
      if (!streaks4.length) {
        fourPlusText.textContent = "No 4+ streaks found.";
      } else {
        fourPlusText.innerHTML = `
          <ul style="margin:0;padding-left:18px;">
            ${streaks4.map(s =>
              `<li><b>${s.spot}</b> — <b>${s.len}</b> straight (rounds #${s.startIndex + 1}–#${s.endIndex + 1})</li>`
            ).join("")}
          </ul>
        `;
      }
    }

    function clearAll() {
      urlEl.value = "";
      statusEl.textContent = "";
      errEl.textContent = "";
      metaEl.textContent = "";
      tbody.innerHTML = "";
      tbl.style.display = "none";
      totalGrossEl.textContent = "";
      totalEntryEl.textContent = "";
      totalNetEl.textContent = "";
      streakCard.style.display = "none";
      bestLenPill.textContent = "";
      bestStreakText.textContent = "";
      fourPlusPill.textContent = "";
      fourPlusText.textContent = "";
      urlEl.focus();
    }

    clearBtn.addEventListener("click", () => clearAll());

    runBtn.addEventListener("click", async () => {
      errEl.textContent = "";
      statusEl.textContent = "Working...";
      metaEl.textContent = "";
      tbody.innerHTML = "";
      tbl.style.display = "none";
      totalGrossEl.textContent = "";
      totalEntryEl.textContent = "";
      totalNetEl.textContent = "";
      streakCard.style.display = "none";

      const url = urlEl.value.trim();
      const perTop = Number(perTopEl.value) || 0;
      const entryFee = Number(entryFeeEl.value) || 0;

      try {
        const res = await fetch(API, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ url, bottomMode: 1 })
        });

        const data = await res.json();
        if (!res.ok || !data.ok) throw new Error(data.error || "Request failed");

        const spotCountsRaw =
          (data && data.spotCounts && typeof data.spotCounts === "object") ? data.spotCounts : null;

        if (!spotCountsRaw) {
          throw new Error("spotCounts missing. Update index.js /api/generate to include spotCounts and restart server.");
        }

        const spotCounts = {};
        for (const [k, v] of Object.entries(spotCountsRaw)) {
          const nk = normKey(k);
          if (!nk) continue;
          spotCounts[nk] = (spotCounts[nk] || 0) + (Number(v) || 0);
        }

        const winsByName = new Map();
        const topLines = Array.isArray(data.topList) ? data.topList : [];
        for (const line of topLines) {
          const name = normKey(stripOurNumbering(line));
          if (!name) continue;
          winsByName.set(name, (winsByName.get(name) || 0) + 1);
        }

        // streaks from per-round winners
        const firstPlaceSequence = buildFirstPlaceSequence(topLines);
        renderStreaks(firstPlaceSequence);

        const names = Object.keys(spotCounts);

        const rows = names.map(name => {
          const spots = Number(spotCounts[name] || 0);
          const wins = Number(winsByName.get(name) || 0);
          const gross = wins * perTop;
          const entryPaid = spots * entryFee;
          const net = gross - entryPaid;
          return { name, spots, wins, gross, entryPaid, net };
        }).sort((a, b) => (b.net - a.net) || (b.wins - a.wins) || a.name.localeCompare(b.name));

        metaEl.textContent = `Rounds: ${data.roundsCount} • $/win: ${money(perTop)} • Entry/spot: ${money(entryFee)} • Spots from Round 1`;

        let totalGross = 0, totalEntry = 0, totalNet = 0;

        for (const r of rows) {
          totalGross += r.gross;
          totalEntry += r.entryPaid;
          totalNet += r.net;

          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${r.name}</td>
            <td class="right">${r.spots}</td>
            <td class="right">${r.wins}</td>
            <td class="right">${money(r.gross)}</td>
            <td class="right">${money(r.entryPaid)}</td>
            <td class="right"><b>${money(r.net)}</b></td>
          `;
          tbody.appendChild(tr);
        }

        totalGrossEl.textContent = money(totalGross);
        totalEntryEl.textContent = money(totalEntry);
        totalNetEl.textContent = money(totalNet);

        tbl.style.display = "table";
        statusEl.textContent = "Done.";
      } catch (e) {
        errEl.textContent = e.message;
        statusEl.textContent = "";
      }
    });
  </script>
</body>
</html>
